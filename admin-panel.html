<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - UmrahFlex CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="flex items-center">
                        <i class="fas fa-kaaba text-2xl text-purple-600 mr-2"></i>
                        <span class="text-xl font-bold text-gray-800">UmrahFlex CRM</span>
                    </a>
                    <span class="text-gray-300">|</span>
                    <span class="text-gray-600 font-medium">Dashboard</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="refreshDashboard()" class="text-gray-600 hover:text-purple-600 transition">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                    <a href="packages.html" class="text-gray-600 hover:text-purple-600 transition">
                        <i class="fas fa-box-open mr-1"></i> Packages
                    </a>
                    <a href="inbox.html" class="text-gray-600 hover:text-purple-600 transition">
                        <i class="fas fa-inbox mr-1"></i> Inbox
                    </a>
                    <a href="index.html" class="text-gray-600 hover:text-purple-600 transition">
                        <i class="fas fa-home mr-1"></i> Home
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">ðŸ“Š Dashboard Overview</h1>
            <p class="text-gray-600 mt-1">Real-time business intelligence and analytics</p>
        </div>

        <!-- Main Statistics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Packages -->
            <div class="stat-card bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm font-medium uppercase">Total Packages</p>
                        <p id="statTotalPackages" class="text-4xl font-bold mt-2">--</p>
                        <p class="text-blue-100 text-sm mt-2">
                            <span id="statActivePackages" class="font-semibold">--</span> Active
                        </p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-box-open text-4xl"></i>
                    </div>
                </div>
            </div>

            <!-- Total Leads -->
            <div class="stat-card bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-sm font-medium uppercase">Total Leads</p>
                        <p id="statTotalLeads" class="text-4xl font-bold mt-2">--</p>
                        <p class="text-purple-100 text-sm mt-2">
                            <span id="statNewLeads" class="font-semibold">--</span> New
                        </p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-users text-4xl"></i>
                    </div>
                </div>
            </div>

            <!-- Conversion Rate -->
            <div class="stat-card bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm font-medium uppercase">Converted</p>
                        <p id="statConvertedLeads" class="text-4xl font-bold mt-2">--</p>
                        <p class="text-green-100 text-sm mt-2">
                            <span id="statConversionRate" class="font-semibold">--</span>% Rate
                        </p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-trophy text-4xl"></i>
                    </div>
                </div>
            </div>

            <!-- Team Size -->
            <div class="stat-card bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-orange-100 text-sm font-medium uppercase">Team Members</p>
                        <p id="statTotalTeam" class="text-4xl font-bold mt-2">--</p>
                        <p class="text-orange-100 text-sm mt-2">
                            <span id="statTotalOffices" class="font-semibold">--</span> Offices
                        </p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-user-tie text-4xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secondary Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Qualified</p>
                        <p id="statQualified" class="text-2xl font-bold text-green-600">--</p>
                    </div>
                    <i class="fas fa-check-circle text-2xl text-green-500"></i>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Contacted</p>
                        <p id="statContacted" class="text-2xl font-bold text-yellow-600">--</p>
                    </div>
                    <i class="fas fa-phone text-2xl text-yellow-500"></i>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">High Priority</p>
                        <p id="statHighPriority" class="text-2xl font-bold text-red-600">--</p>
                    </div>
                    <i class="fas fa-exclamation-circle text-2xl text-red-500"></i>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Lost</p>
                        <p id="statLost" class="text-2xl font-bold text-gray-600">--</p>
                    </div>
                    <i class="fas fa-times-circle text-2xl text-gray-500"></i>
                </div>
            </div>
        </div>

        <!-- Charts and Recent Activity -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Lead Status Distribution -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Lead Status Distribution</h3>
                <canvas id="leadStatusChart" height="200"></canvas>
            </div>

            <!-- Package Distribution -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Packages by Airport</h3>
                <canvas id="packageChart" height="200"></canvas>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Recent Leads -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">Recent Leads</h3>
                    <a href="inbox.html" class="text-purple-600 hover:text-purple-700 text-sm font-medium">
                        View All â†’
                    </a>
                </div>
                <div id="recentLeadsList" class="space-y-3">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Quick Actions</h3>
                <div class="space-y-3">
                    <a href="packages.html" class="block bg-gradient-to-r from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 rounded-lg p-4 transition">
                        <div class="flex items-center">
                            <div class="bg-blue-500 rounded-lg p-3 mr-4">
                                <i class="fas fa-plus text-white text-xl"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">Add New Package</p>
                                <p class="text-sm text-gray-600">Create Umrah package</p>
                            </div>
                        </div>
                    </a>

                    <a href="inbox.html" class="block bg-gradient-to-r from-purple-50 to-purple-100 hover:from-purple-100 hover:to-purple-200 rounded-lg p-4 transition">
                        <div class="flex items-center">
                            <div class="bg-purple-500 rounded-lg p-3 mr-4">
                                <i class="fas fa-inbox text-white text-xl"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">View Inbox</p>
                                <p class="text-sm text-gray-600">Manage customer leads</p>
                            </div>
                        </div>
                    </a>

                    <a href="packages.html" class="block bg-gradient-to-r from-green-50 to-green-100 hover:from-green-100 hover:to-green-200 rounded-lg p-4 transition">
                        <div class="flex items-center">
                            <div class="bg-green-500 rounded-lg p-3 mr-4">
                                <i class="fas fa-list text-white text-xl"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">All Packages</p>
                                <p class="text-sm text-gray-600">View and manage packages</p>
                            </div>
                        </div>
                    </a>

                    <button onclick="refreshDashboard()" class="block w-full bg-gradient-to-r from-orange-50 to-orange-100 hover:from-orange-100 hover:to-orange-200 rounded-lg p-4 transition">
                        <div class="flex items-center">
                            <div class="bg-orange-500 rounded-lg p-3 mr-4">
                                <i class="fas fa-sync-alt text-white text-xl"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold text-gray-900">Refresh Dashboard</p>
                                <p class="text-sm text-gray-600">Update all statistics</p>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =========================
        // âœ… API CONFIG
        // =========================
        const API_URL = 'http://localhost:3000/api';

        async function apiFetch(path, options = {}) {
            const res = await fetch(`${API_URL}${path}`, {
                headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
                ...options,
            });

            const text = await res.text();
            let data;
            try { data = text ? JSON.parse(text) : null; } catch { data = text; }

            if (!res.ok) throw new Error((data && data.error) ? data.error : (data || `HTTP ${res.status}`));
            return data;
        }

        // =========================
        // âœ… STATE
        // =========================
        let dashboardData = {
            packages: [],
            leads: [],
            offices: [],
            teams: []
        };

        let leadStatusChart = null;
        let packageChart = null;

        // =========================
        // âœ… LOAD DATA
        // =========================
        async function loadDashboardData() {
            try {
                // Load all data in parallel
                const [packages, leads, offices, teams] = await Promise.all([
                    apiFetch('/packages'),
                    apiFetch('/leads'),
                    apiFetch('/offices'),
                    apiFetch('/teams')
                ]);

                dashboardData = {
                    packages: Array.isArray(packages) ? packages : [],
                    leads: Array.isArray(leads) ? leads : [],
                    offices: Array.isArray(offices) ? offices : [],
                    teams: Array.isArray(teams) ? teams : []
                };

                updateStatistics();
                updateCharts();
                updateRecentLeads();
            } catch (err) {
                console.error('Failed to load dashboard data:', err);
                alert('âŒ Failed to load dashboard data. Please check your connection.');
            }
        }

        // =========================
        // âœ… UPDATE STATISTICS
        // =========================
        function updateStatistics() {
            const { packages, leads, offices, teams } = dashboardData;

            // Package stats
            const totalPackages = packages.length;
            const activePackages = packages.filter(p => p.status === 'Active').length;
            document.getElementById('statTotalPackages').textContent = totalPackages;
            document.getElementById('statActivePackages').textContent = activePackages;

            // Lead stats
            const totalLeads = leads.length;
            const newLeads = leads.filter(l => l.status === 'new').length;
            const contactedLeads = leads.filter(l => l.status === 'contacted').length;
            const qualifiedLeads = leads.filter(l => l.status === 'qualified').length;
            const convertedLeads = leads.filter(l => l.status === 'converted').length;
            const lostLeads = leads.filter(l => l.status === 'lost').length;
            const highPriorityLeads = leads.filter(l => l.priority === 'high').length;

            document.getElementById('statTotalLeads').textContent = totalLeads;
            document.getElementById('statNewLeads').textContent = newLeads;
            document.getElementById('statConvertedLeads').textContent = convertedLeads;
            document.getElementById('statQualified').textContent = qualifiedLeads;
            document.getElementById('statContacted').textContent = contactedLeads;
            document.getElementById('statLost').textContent = lostLeads;
            document.getElementById('statHighPriority').textContent = highPriorityLeads;

            // Conversion rate
            const conversionRate = totalLeads > 0 ? ((convertedLeads / totalLeads) * 100).toFixed(1) : 0;
            document.getElementById('statConversionRate').textContent = conversionRate;

            // Team stats
            document.getElementById('statTotalTeam').textContent = teams.length;
            document.getElementById('statTotalOffices').textContent = offices.length;
        }

        // =========================
        // âœ… UPDATE CHARTS
        // =========================
        function updateCharts() {
            const { packages, leads } = dashboardData;

            // Lead Status Chart
            const statusCounts = {
                new: leads.filter(l => l.status === 'new').length,
                contacted: leads.filter(l => l.status === 'contacted').length,
                qualified: leads.filter(l => l.status === 'qualified').length,
                converted: leads.filter(l => l.status === 'converted').length,
                lost: leads.filter(l => l.status === 'lost').length
            };

            if (leadStatusChart) leadStatusChart.destroy();
            
            const ctx1 = document.getElementById('leadStatusChart');
            leadStatusChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['New', 'Contacted', 'Qualified', 'Converted', 'Lost'],
                    datasets: [{
                        data: [
                            statusCounts.new,
                            statusCounts.contacted,
                            statusCounts.qualified,
                            statusCounts.converted,
                            statusCounts.lost
                        ],
                        backgroundColor: [
                            '#3b82f6', // blue
                            '#eab308', // yellow
                            '#10b981', // green
                            '#8b5cf6', // purple
                            '#ef4444'  // red
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Package by Airport Chart
            const airportCounts = {};
            packages.forEach(p => {
                const airport = p.departure_airport || 'Unknown';
                airportCounts[airport] = (airportCounts[airport] || 0) + 1;
            });

            if (packageChart) packageChart.destroy();

            const ctx2 = document.getElementById('packageChart');
            packageChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: Object.keys(airportCounts),
                    datasets: [{
                        label: 'Packages',
                        data: Object.values(airportCounts),
                        backgroundColor: [
                            '#3b82f6',
                            '#8b5cf6',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444'
                        ],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // =========================
        // âœ… UPDATE RECENT LEADS
        // =========================
        function updateRecentLeads() {
            const { leads } = dashboardData;
            const recentLeads = [...leads]
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 5);

            const container = document.getElementById('recentLeadsList');

            if (recentLeads.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-2"></i>
                        <p>No leads yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recentLeads.map(lead => {
                const statusColors = {
                    new: 'bg-blue-100 text-blue-800',
                    contacted: 'bg-yellow-100 text-yellow-800',
                    qualified: 'bg-green-100 text-green-800',
                    converted: 'bg-purple-100 text-purple-800',
                    lost: 'bg-red-100 text-red-800'
                };

                const priorityIcons = {
                    high: '<i class="fas fa-exclamation-circle text-red-500"></i>',
                    medium: '<i class="fas fa-exclamation-triangle text-orange-500"></i>',
                    low: '<i class="fas fa-info-circle text-blue-500"></i>'
                };

                const timeAgo = getTimeAgo(new Date(lead.created_at));
                const statusClass = statusColors[lead.status] || 'bg-gray-100 text-gray-800';

                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:border-purple-300 hover:shadow-md transition">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <p class="font-semibold text-gray-900">${lead.customer_name || 'N/A'}</p>
                                    ${priorityIcons[lead.priority] || ''}
                                </div>
                                <p class="text-sm text-gray-600 mb-2">
                                    ${lead.wa_number ? `<i class="fab fa-whatsapp text-green-600"></i> ${lead.wa_number}` : ''}
                                </p>
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                                        ${(lead.status || 'new').toUpperCase()}
                                    </span>
                                    <span class="text-xs text-gray-500">${timeAgo}</span>
                                </div>
                            </div>
                            <a href="inbox.html" class="text-purple-600 hover:text-purple-700">
                                <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // =========================
        // âœ… UTILITY FUNCTIONS
        // =========================
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            return date.toLocaleDateString();
        }

        function refreshDashboard() {
            loadDashboardData();
        }

        // =========================
        // âœ… INITIALIZE
        // =========================
        async function init() {
            try {
                await loadDashboardData();
                console.log('âœ… Dashboard loaded successfully');
            } catch (err) {
                console.error('âŒ Dashboard initialization error:', err);
            }
        }

        // Start
        init();
    </script>
</body>
</html>
