<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - UmrahFlex CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .stat-card { transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* Sirf ye tabdeeli ki hai: Charts ko control karne ke liye */
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="flex items-center">
                        <i class="fas fa-kaaba text-2xl text-purple-600 mr-2"></i>
                        <span class="text-xl font-bold text-gray-800">UmrahFlex CRM</span>
                    </a>
                    <span class="text-gray-300">|</span>
                    <span class="text-gray-600 font-medium">Dashboard</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="refreshDashboard()" class="text-gray-600 hover:text-purple-600 transition">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                    <a href="packages.html" class="text-gray-600 hover:text-purple-600 transition"><i class="fas fa-box-open mr-1"></i> Packages</a>
                    <a href="inbox.html" class="text-gray-600 hover:text-purple-600 transition"><i class="fas fa-inbox mr-1"></i> Inbox</a>
                    <a href="index.html" class="text-gray-600 hover:text-purple-600 transition"><i class="fas fa-home mr-1"></i> Home</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">ðŸ“Š Dashboard Overview</h1>
            <p class="text-gray-600 mt-1">Real-time business intelligence and analytics</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm font-medium uppercase">Total Packages</p>
                        <p id="statTotalPackages" class="text-4xl font-bold mt-2">--</p>
                        <p class="text-blue-100 text-sm mt-2"><span id="statActivePackages" class="font-semibold">--</span> Active</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-4"><i class="fas fa-box-open text-4xl"></i></div>
                </div>
            </div>
            <div class="stat-card bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-100 text-sm font-medium uppercase">Total Leads</p>
                        <p id="statTotalLeads" class="text-4xl font-bold mt-2">--</p>
                        <p class="text-purple-100 text-sm mt-2"><span id="statNewLeads" class="font-semibold">--</span> New</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-4"><i class="fas fa-users text-4xl"></i></div>
                </div>
            </div>
            <div class="stat-card bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm font-medium uppercase">Converted</p>
                        <p id="statConvertedLeads" class="text-4xl font-bold mt-2">--</p>
                        <p class="text-green-100 text-sm mt-2"><span id="statConversionRate" class="font-semibold">--</span>% Rate</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-4"><i class="fas fa-trophy text-4xl"></i></div>
                </div>
            </div>
            <div class="stat-card bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-orange-100 text-sm font-medium uppercase">Team Members</p>
                        <p id="statTotalTeam" class="text-4xl font-bold mt-2">--</p>
                        <p class="text-orange-100 text-sm mt-2"><span id="statTotalOffices" class="font-semibold">--</span> Offices</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-4"><i class="fas fa-user-tie text-4xl"></i></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow p-4"><div class="flex items-center justify-between"><div><p class="text-sm text-gray-500">Qualified</p><p id="statQualified" class="text-2xl font-bold text-green-600">--</p></div><i class="fas fa-check-circle text-2xl text-green-500"></i></div></div>
            <div class="bg-white rounded-lg shadow p-4"><div class="flex items-center justify-between"><div><p class="text-sm text-gray-500">Contacted</p><p id="statContacted" class="text-2xl font-bold text-yellow-600">--</p></div><i class="fas fa-phone text-2xl text-yellow-500"></i></div></div>
            <div class="bg-white rounded-lg shadow p-4"><div class="flex items-center justify-between"><div><p class="text-sm text-gray-500">High Priority</p><p id="statHighPriority" class="text-2xl font-bold text-red-600">--</p></div><i class="fas fa-exclamation-circle text-2xl text-red-500"></i></div></div>
            <div class="bg-white rounded-lg shadow p-4"><div class="flex items-center justify-between"><div><p class="text-sm text-gray-500">Lost</p><p id="statLost" class="text-2xl font-bold text-gray-600">--</p></div><i class="fas fa-times-circle text-2xl text-gray-500"></i></div></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Lead Status Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="leadStatusChart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Packages by Airport</h3>
                <div class="chart-wrapper">
                    <canvas id="packageChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">Recent Leads</h3>
                    <a href="inbox.html" class="text-purple-600 hover:text-purple-700 text-sm font-medium">View All â†’</a>
                </div>
                <div id="recentLeadsList" class="space-y-3"></div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Quick Actions</h3>
                <div class="space-y-3">
                    <a href="packages.html" class="block bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4 hover:shadow-sm transition">
                        <div class="flex items-center">
                            <div class="bg-blue-500 rounded-lg p-3 mr-4"><i class="fas fa-plus text-white text-xl"></i></div>
                            <div><p class="font-semibold text-gray-900">Add New Package</p><p class="text-sm text-gray-600">Create Umrah package</p></div>
                        </div>
                    </a>
                    <a href="inbox.html" class="block bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-4 hover:shadow-sm transition">
                        <div class="flex items-center">
                            <div class="bg-purple-500 rounded-lg p-3 mr-4"><i class="fas fa-inbox text-white text-xl"></i></div>
                            <div><p class="font-semibold text-gray-900">View Inbox</p><p class="text-sm text-gray-600">Manage customer leads</p></div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let dashboardData = { packages: [], leads: [], offices: [], teams: [] };
        let leadStatusChart = null;
        let packageChart = null;

        async function apiFetch(path) {
            const res = await fetch(`${API_URL}${path}`);
            return res.json();
        }

        async function loadDashboardData() {
            try {
                const [packages, leads, offices, teams] = await Promise.all([
                    apiFetch('/packages'), apiFetch('/leads'), apiFetch('/offices'), apiFetch('/teams')
                ]);
                dashboardData = { 
                    packages: Array.isArray(packages) ? packages : [], 
                    leads: Array.isArray(leads) ? leads : [], 
                    offices: Array.isArray(offices) ? offices : [], 
                    teams: Array.isArray(teams) ? teams : [] 
                };
                updateStatistics();
                updateCharts();
                updateRecentLeads();
            } catch (err) { console.error('Load Error:', err); }
        }

        function updateStatistics() {
            const { packages, leads, offices, teams } = dashboardData;
            document.getElementById('statTotalPackages').textContent = packages.length;
            document.getElementById('statActivePackages').textContent = packages.filter(p => p.status === 'Active').length;
            document.getElementById('statTotalLeads').textContent = leads.length;
            document.getElementById('statNewLeads').textContent = leads.filter(l => l.status === 'new').length;
            document.getElementById('statConvertedLeads').textContent = leads.filter(l => l.status === 'converted').length;
            document.getElementById('statQualified').textContent = leads.filter(l => l.status === 'qualified').length;
            document.getElementById('statContacted').textContent = leads.filter(l => l.status === 'contacted').length;
            document.getElementById('statLost').textContent = leads.filter(l => l.status === 'lost').length;
            document.getElementById('statHighPriority').textContent = leads.filter(l => l.priority === 'high').length;
            document.getElementById('statConversionRate').textContent = leads.length > 0 ? ((leads.filter(l => l.status === 'converted').length / leads.length) * 100).toFixed(1) : 0;
            document.getElementById('statTotalTeam').textContent = teams.length;
            document.getElementById('statTotalOffices').textContent = offices.length;
        }

        function updateCharts() {
            const { packages, leads } = dashboardData;
            if (leadStatusChart) leadStatusChart.destroy();
            leadStatusChart = new Chart(document.getElementById('leadStatusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['New', 'Contacted', 'Qualified', 'Converted', 'Lost'],
                    datasets: [{
                        data: [
                            leads.filter(l => l.status === 'new').length,
                            leads.filter(l => l.status === 'contacted').length,
                            leads.filter(l => l.status === 'qualified').length,
                            leads.filter(l => l.status === 'converted').length,
                            leads.filter(l => l.status === 'lost').length
                        ],
                        backgroundColor: ['#3b82f6', '#eab308', '#10b981', '#8b5cf6', '#ef4444']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });

            const airportCounts = {};
            packages.forEach(p => { const a = p.departure_airport || 'Unknown'; airportCounts[a] = (airportCounts[a] || 0) + 1; });
            if (packageChart) packageChart.destroy();
            packageChart = new Chart(document.getElementById('packageChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(airportCounts),
                    datasets: [{ label: 'Packages', data: Object.values(airportCounts), backgroundColor: '#8b5cf6', borderRadius: 8 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }

        function updateRecentLeads() {
            const container = document.getElementById('recentLeadsList');
            const recent = [...dashboardData.leads].sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 5);
            if (recent.length === 0) { container.innerHTML = '<p class="text-center py-4 text-gray-500">No leads yet</p>'; return; }
            container.innerHTML = recent.map(lead => `
                <div class="border border-gray-200 rounded-lg p-4 hover:border-purple-300 transition flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-gray-900">${lead.customer_name || 'N/A'}</p>
                        <p class="text-sm text-gray-600"><i class="fab fa-whatsapp text-green-600"></i> ${lead.wa_number || ''}</p>
                    </div>
                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">${(lead.status || 'new').toUpperCase()}</span>
                </div>
            `).join('');
        }

        function refreshDashboard() { loadDashboardData(); }
        window.onload = loadDashboardData;
    </script>
</body>
</html>
