<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Inbox - Umrah System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            direction: rtl;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // =========================
        // âœ… CONFIGURATION (VPS + Nginx Proxy)
        // =========================
        // IMPORTANT: Frontend must be opened from VPS URL (NOT file:/// or GitHub Pages)
        // Example: http://77.42.83.42/inbox.html?id=1
        const API_BASE = '/api';

        async function apiFetch(path, options = {}) {
            const res = await fetch(`${API_BASE}${path}`, {
                headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
                ...options
            });

            const text = await res.text();
            let data;
            try { data = text ? JSON.parse(text) : null; } catch { data = text; }

            if (!res.ok) {
                const msg = (data && data.error) ? data.error : (data || `HTTP ${res.status}`);
                throw new Error(msg);
            }
            return data;
        }
        
        // Simple Icons
        const Icons = {
            MessageCircle: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>,
            Phone: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>,
            Calendar: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
            Users: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            UserCheck: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            AlertCircle: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            TrendingUp: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>,
        };

        function UmrahInbox() {
            const [conversation, setConversation] = useState(null);
            const [loading, setLoading] = useState(true);
            const [updating, setUpdating] = useState(false);
            const [error, setError] = useState(null);

            const urlParams = new URLSearchParams(window.location.search);
            const leadIdFromQuery = urlParams.get('id') || urlParams.get('lead_id');

            const lastSeg = window.location.pathname.split('/').filter(Boolean).pop();
            const leadIdFromPath = (lastSeg && /^\d+$/.test(lastSeg)) ? lastSeg : null;

            const leadId = leadIdFromQuery || leadIdFromPath;

            useEffect(() => {
                loadConversation();
            }, []);

            const loadConversation = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    if (!leadId) throw new Error('Lead ID Ù†ÛÛŒÚº Ù…Ù„Ø§Û” Ø¨Ø±Ø§Û Ú©Ø±Ù… URL Ù…ÛŒÚº ?id=123 Ø¯ÛŒÚº');

                    let lead = null;

                    try { lead = await apiFetch(`/leads/${leadId}`); } catch (e) {}

                    if (!lead) {
                        try {
                            const data = await apiFetch(`/leads?lead_id=${encodeURIComponent(leadId)}`);
                            if (Array.isArray(data)) lead = data[0] || null;
                            else if (data && Array.isArray(data.leads)) lead = data.leads[0] || null;
                            else if (data && data.lead_id) lead = data;
                        } catch (e) {}
                    }

                    if (!lead) {
                        const data = await apiFetch('/leads');
                        const list = Array.isArray(data) ? data : (data?.leads || []);
                        lead = list.find(x => String(x.lead_id) === String(leadId)) || null;
                    }

                    if (!lead) throw new Error('Lead Ù†ÛÛŒÚº Ù…Ù„Ø§');

                    const messages = Array.isArray(lead.messages) ? lead.messages : [];
                    setConversation({ ...lead, messages });
                    setLoading(false);
                } catch (err) {
                    setError(err.message || 'ÚˆÛŒÙ¹Ø§ Ù„ÙˆÚˆ Ù†ÛÛŒÚº ÛÙˆ Ø³Ú©Ø§');
                    setLoading(false);
                }
            };

            const updateStatus = async (newStatus) => {
                const statusLabels = {
                    'new': 'Ù†ÛŒØ§',
                    'contacted': 'Ø±Ø§Ø¨Ø·Û ÛÙˆ Ú¯ÛŒØ§',
                    'negotiating': 'Ø¨Ø§Øª Ú†ÛŒØª Ø¬Ø§Ø±ÛŒ',
                    'deal_done': 'ÚˆÛŒÙ„ ÛÙˆ Ú¯Ø¦ÛŒ',
                    'follow_up': 'ÙØ§Ù„Ùˆ Ø§Ù¾',
                    'lost': 'Lead Lost',
                    'cancelled': 'Ù…Ù†Ø³ÙˆØ®'
                };

                if (!confirm(`Ú©ÛŒØ§ Ø¢Ù¾ status Ú©Ùˆ "${statusLabels[newStatus]}" Ù…ÛŒÚº ØªØ¨Ø¯ÛŒÙ„ Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ`)) return;

                try {
                    setUpdating(true);

                    const updated = await apiFetch(`/leads/${conversation.lead_id}/status`, {
                        method: 'PATCH',
                        body: JSON.stringify({ status: newStatus })
                    });

                    setConversation(prev => ({
                        ...prev,
                        ...(updated && typeof updated === 'object' ? updated : {}),
                        status: newStatus,
                        last_contact_date: new Date().toISOString()
                    }));

                    alert(`âœ… Status ${statusLabels[newStatus]} Ù…ÛŒÚº update ÛÙˆ Ú¯ÛŒØ§!`);
                    setUpdating(false);
                } catch (err) {
                    alert('âŒ ' + (err.message || 'Status update Ù†ÛÛŒÚº ÛÙˆ Ø³Ú©Ø§'));
                    setUpdating(false);
                }
            };

            const getStatusBadge = (status) => {
                const badges = {
                    new: { bg: 'bg-blue-100', text: 'text-blue-700', label: 'ğŸ†• Ù†ÛŒØ§' },
                    contacted: { bg: 'bg-yellow-100', text: 'text-yellow-700', label: 'ğŸ“ Ø±Ø§Ø¨Ø·Û ÛÙˆØ§' },
                    negotiating: { bg: 'bg-purple-100', text: 'text-purple-700', label: 'ğŸ’¬ Ø¨Ø§Øª Ú†ÛŒØª' },
                    deal_done: { bg: 'bg-green-100', text: 'text-green-700', label: 'âœ… ÚˆÛŒÙ„' },
                    follow_up: { bg: 'bg-orange-100', text: 'text-orange-700', label: 'ğŸ”„ ÙØ§Ù„Ùˆ Ø§Ù¾' },
                    lost: { bg: 'bg-red-100', text: 'text-red-700', label: 'âŒ Lost' },
                    cancelled: { bg: 'bg-gray-100', text: 'text-gray-700', label: 'ğŸš« Ù…Ù†Ø³ÙˆØ®' }
                };
                const badge = badges[status] || badges.new;
                return (
                    <span className={`px-3 py-1 rounded-full text-sm font-semibold ${badge.bg} ${badge.text}`}>
                        {badge.label}
                    </span>
                );
            };

            const getPriorityBadge = (priority) => {
                const badges = {
                    urgent: { bg: 'bg-red-500', text: 'text-white', label: 'ğŸš¨ Urgent' },
                    high: { bg: 'bg-orange-500', text: 'text-white', label: 'âš ï¸ High' },
                    medium: { bg: 'bg-blue-500', text: 'text-white', label: 'ğŸ“Œ Medium' },
                    low: { bg: 'bg-gray-500', text: 'text-white', label: 'ğŸ“‹ Low' }
                };
                const badge = badges[priority] || badges.medium;
                return (
                    <span className={`px-2 py-1 rounded text-xs font-semibold ${badge.bg} ${badge.text}`}>
                        {badge.label}
                    </span>
                );
            };

            const formatCurrency = (amount, currency='PKR') => {
                if (amount == null || amount === '') return '-';
                try { return `${currency} ${Number(amount).toLocaleString()}`; } catch { return `${currency} ${amount}`; }
            };

            const getLeadAge = (created_at) => {
                if (!created_at) return '';
                const now = new Date();
                const created = new Date(created_at);
                const hours = Math.floor((now - created) / (1000 * 60 * 60));
                if (hours < 1) return 'Ø§Ø¨Ú¾ÛŒ Ø§Ø¨Ú¾ÛŒ';
                if (hours < 24) return `${hours} Ú¯Ú¾Ù†Ù¹Û’ Ù¾ÛÙ„Û’`;
                const days = Math.floor(hours / 24);
                return `${days} Ø¯Ù† Ù¾ÛÙ„Û’`;
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-green-600 mx-auto mb-4"></div>
                            <p className="text-gray-600 text-lg">Ù„ÙˆÚˆ ÛÙˆ Ø±ÛØ§ ÛÛ’...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-red-50 to-orange-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md text-center">
                            <div className="text-red-500 text-6xl mb-4">âš ï¸</div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">Ø®Ø±Ø§Ø¨ÛŒ!</h2>
                            <p className="text-gray-600">{error}</p>
                            <button onClick={loadConversation} className="mt-4 bg-gray-800 text-white px-4 py-2 rounded-lg">
                                Ø¯ÙˆØ¨Ø§Ø±Û Ù„ÙˆÚˆ Ú©Ø±ÛŒÚº
                            </button>
                        </div>
                    </div>
                );
            }

            // âœ… rest of your JSX remains SAME...
            // (Your UI code continues exactly as you pasted)

            return (
                <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
                    {/* ... keep the rest same (no change needed) ... */}
                    <div className="bg-gradient-to-r from-green-600 to-emerald-600 text-white shadow-2xl">
                        <div className="max-w-7xl mx-auto px-4 py-6">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-2xl md:text-3xl font-bold mb-2 flex items-center gap-2">
                                        <Icons.MessageCircle />
                                        Team Inbox
                                    </h1>
                                    <p className="text-green-100 text-sm">
                                        Lead ID: #{conversation.lead_id} {conversation.created_at ? `â€¢ ${getLeadAge(conversation.created_at)}` : ''}
                                    </p>
                                </div>
                                <div className="text-right">
                                    {getPriorityBadge(conversation.priority)}
                                    <div className="mt-2">{getStatusBadge(conversation.status)}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* âœ… keep your remaining UI EXACTLY SAME */}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<UmrahInbox />);
    </script>
</body>
</html>
